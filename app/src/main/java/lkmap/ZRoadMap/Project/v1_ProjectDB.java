package lkmap.ZRoadMap.Project;

import java.io.File;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import dingtu.ZRoadMap.PubVar;
import lkmap.Dataset.ASQLiteDatabase;
import lkmap.Dataset.SQLiteDataReader;
import lkmap.Tools.Tools;

public class v1_ProjectDB 
{
	public v1_ProjectDB(){}
	
	//工程管理器
	private v1_ProjectExplorer m_ProjectExplorer = null;
	public v1_ProjectExplorer GetProjectExplorer(){return this.m_ProjectExplorer;}
	
	//图层管理器
	private v1_LayerExplorer m_LayerExplorer = null;
	public v1_LayerExplorer GetLayerExplorer(){return this.m_LayerExplorer;}
	
	//底图管理器
	private v1_BKLayerExplorer m_BKLayerExplorer = null;
	public v1_BKLayerExplorer GetBKLayerExplorer(){return this.m_BKLayerExplorer;}
	
	//图层渲染器
	private v1_LayerRenderExplorer m_LayerRenderExplorer = null;
	public v1_LayerRenderExplorer GetLayerRenderExplorer()
	{
		if (this.m_LayerRenderExplorer==null)this.m_LayerRenderExplorer=new v1_LayerRenderExplorer();
		return this.m_LayerRenderExplorer;
	}
	
	/**
	 * 创建工程，以工程名称做为目录名，目录下有project.dbx工程配置文件
	 * @param prjName
	 */
	public boolean CreateProject(String prjName)
	{
		String PrjPath = PubVar.m_SysAbsolutePath+"/Data/"+prjName;
		
	    //检查工程目录，如果没有则创建工程目录
	    if (!lkmap.Tools.Tools.ExistFile(PrjPath))
	    {
	    	if ((new File(PrjPath)).mkdirs())
	    	{
	    		//创建工程相关子目录及配置文件
	    		Tools.CopyFile(PubVar.m_SysAbsolutePath+"/sysfile/Template.dbx", PrjPath+"/TAData.dbx");
	    		Tools.CopyFile(PubVar.m_SysAbsolutePath+"/sysfile/Project.dbx", PrjPath+"/Project.dbx");
	    		this.OpenDatabase(PrjPath+"/Project.dbx");
	    		return true;
	    	}
	    }
	    return false;
	}
	
	//标识是否已经打开工程
	private boolean m_AlwaysOpenProject = false;
	public boolean AlwaysOpenProject(){return this.m_AlwaysOpenProject;}
	
	public boolean OpenProject(String prjName)
	{
		return this.OpenProject(prjName, true);
	}
	/**
	 * 打开工程
	 * @param prjName
	 * @saveInfo 是否保存上次打开信息
	 * @return
	 */
	public boolean OpenProject(String prjName,boolean saveInfo)
	{

		String PrjFileFullName = PubVar.m_SysAbsolutePath+"/Data/"+prjName+"/Project.dbx";
		
		//打开工程 配置库
		if (!Tools.ExistFile(PrjFileFullName)) return false;
		this.OpenDatabase(PrjFileFullName);

		//工程管理器
		if (this.m_ProjectExplorer==null) this.m_ProjectExplorer = new v1_ProjectExplorer();
		this.m_ProjectExplorer.SetBindProjectDB(this);
		this.m_ProjectExplorer.SetProjectName(prjName);
		this.m_ProjectExplorer.LoadProjectInfo();
		
		//打开本工程所对应的图层列表
		if (this.m_LayerExplorer==null)this.m_LayerExplorer = new v1_LayerExplorer();
		this.m_LayerExplorer.SetBindProjectDB(this);
		this.m_LayerExplorer.LoadLayer();
		
		//打开本工程所对应的底图图层管理器
		if (this.m_BKLayerExplorer==null)this.m_BKLayerExplorer = new v1_BKLayerExplorer();
		this.m_BKLayerExplorer.SetBindProjectDB(this);
		this.m_BKLayerExplorer.LoadBKLayer();
		this.m_AlwaysOpenProject = true;
		
		//将本次打开的工程信息存入用户配置库，方便下次以快捷方式打开
		if (saveInfo)
		{
			HashMap<String,String> beforeOpenProjectInfo = new HashMap<String,String>();
			beforeOpenProjectInfo.put("F2", prjName);
			beforeOpenProjectInfo.put("F3", Tools.GetSystemDate());
			PubVar.m_DoEvent.m_UserConfigDB.GetUserParam().SaveUserPara("Tag_BeforeOpenProject",beforeOpenProjectInfo);
		}
		return true;
	}
	
	/**
	 * 关闭工程
	 * @return
	 */
	public boolean CloseProject()
	{
		if (this.m_SQLiteDatabase!=null)this.m_SQLiteDatabase.Close();
		return true;
	}
	

	
	//数据库操作类
	private ASQLiteDatabase m_SQLiteDatabase = null;
	
	//打开数据库
	private void OpenDatabase(String dbFileName)
	{
		if (Tools.ExistFile(dbFileName))
		{
			if (this.m_SQLiteDatabase!=null)this.m_SQLiteDatabase.Close();
			this.m_SQLiteDatabase = new ASQLiteDatabase();
			this.m_SQLiteDatabase.setDatabaseName(dbFileName);
		}
	}
	/**
	 * 得到指定的数据库操作类
	 * @return
	 */
	public ASQLiteDatabase GetSQLiteDatabase()
	{
		return this.m_SQLiteDatabase;
	}
	
	

}

